# –ü—Ä–æ–º—Ç –¥–ª—è Claude Code: Telegram –±–æ—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ—Ä–∏–ª–∞–Ω—Å-–∑–∞–ø—Ä–æ—Å–æ–≤

–°–æ–∑–¥–∞–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ—Ä–∏–ª–∞–Ω—Å-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ 100+ Telegram —á–∞—Ç–æ–≤ —Å —Ñ–æ–Ω–æ–≤—ã–º –≤–æ—Ä–∫–µ—Ä–æ–º –∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –≤—ã–¥–∞—á–µ–π —é–∑–µ—Ä—É.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Worker         ‚îÇ     ‚îÇ    PostgreSQL    ‚îÇ     ‚îÇ   Telegram Bot   ‚îÇ
‚îÇ   (—Ñ–æ–Ω–æ–≤—ã–π)      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ    (–∫–µ—à –¥–∞–Ω–Ω—ã—Ö)  ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   (–æ—Ç–¥–∞—ë—Ç —é–∑–µ—Ä—É) ‚îÇ
‚îÇ                  ‚îÇ     ‚îÇ                  ‚îÇ     ‚îÇ                  ‚îÇ
‚îÇ ‚Ä¢ –ü–∞—Ä—Å–∏—Ç —á–∞—Ç—ã    ‚îÇ     ‚îÇ ‚Ä¢ requests       ‚îÇ     ‚îÇ ‚Ä¢ /start         ‚îÇ
‚îÇ ‚Ä¢ –ê–Ω–∞–ª–∏–∑ Claude  ‚îÇ     ‚îÇ ‚Ä¢ categories     ‚îÇ     ‚îÇ ‚Ä¢ –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏‚îÇ
‚îÇ ‚Ä¢ –ö–∞–∂–¥—ã–µ 2 —á–∞—Å–∞  ‚îÇ     ‚îÇ ‚Ä¢ parse_logs     ‚îÇ     ‚îÇ ‚Ä¢ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –°—Ç–µ–∫

- Python 3.11+
- aiogram 3.x ‚Äî Telegram –±–æ—Ç
- Telethon ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ —á–∞—Ç–æ–≤ (userbot)
- google-genai ‚Äî Gemini API –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- SQLAlchemy + PostgreSQL ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ
- APScheduler ‚Äî –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
- Docker + docker-compose ‚Äî –¥–µ–ø–ª–æ–π

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
freelance_parser/
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py              # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ start.py         # /start, –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ requests.py      # –ü–æ–∫–∞–∑ –∑–∞–ø—Ä–æ—Å–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin.py         # –ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã (—Å—Ç–∞—Ç—É—Å, —Ä—É—á–Ω–æ–π –ø–∞—Ä—Å–∏–Ω–≥)
‚îÇ   ‚îú‚îÄ‚îÄ keyboards.py         # Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îî‚îÄ‚îÄ middlewares.py       # –ü—Ä–æ–≤–µ—Ä–∫–∞ whitelist
‚îÇ
‚îú‚îÄ‚îÄ worker/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py              # –ó–∞–ø—É—Å–∫ –≤–æ—Ä–∫–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ scheduler.py         # APScheduler –∫–æ–Ω—Ñ–∏–≥
‚îÇ   ‚îú‚îÄ‚îÄ jobs/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ parser.py        # –ü–∞—Ä—Å–∏–Ω–≥ —á–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ Telethon
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ analyzer.py      # –ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ Claude
‚îÇ   ‚îî‚îÄ‚îÄ telethon_client.py   # Singleton –∫–ª–∏–µ–Ω—Ç Telethon
‚îÇ
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ config.py            # Pydantic Settings
‚îÇ   ‚îú‚îÄ‚îÄ database.py          # SQLAlchemy async engine
‚îÇ   ‚îî‚îÄ‚îÄ models.py            # ORM –º–æ–¥–µ–ª–∏
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ request_service.py   # CRUD –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ category_service.py  # –†–∞–±–æ—Ç–∞ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
‚îÇ
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ chats.yaml           # –ö–æ–Ω—Ñ–∏–≥ —á–∞—Ç–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
‚îÇ
‚îú‚îÄ‚îÄ alembic/                 # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ Dockerfile.bot
‚îú‚îÄ‚îÄ Dockerfile.worker
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ README.md
```

---

## –ö–æ–Ω—Ñ–∏–≥ —á–∞—Ç–æ–≤ (config/chats.yaml)

```yaml
categories:
  web_dev:
    name: "üåê –í–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞"
    description: "Frontend, Backend, Fullstack"
    chats:
      - "@webdev_jobs"
      - "@frontend_work"
      - "@backend_jobs"
      - -1001234567890  # ID –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞
      
  mobile:
    name: "üì± –ú–æ–±–∏–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞"
    description: "iOS, Android, Flutter, React Native"
    chats:
      - "@ios_jobs"
      - "@android_dev_jobs"
      
  design:
    name: "üé® –î–∏–∑–∞–π–Ω"
    description: "UI/UX, –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω, 3D"
    chats:
      - "@design_freelance"
      - "@ui_ux_jobs"
      
  copywriting:
    name: "‚úçÔ∏è –ö–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥"
    description: "–¢–µ–∫—Å—Ç—ã, –ø–µ—Ä–µ–≤–æ–¥—ã, SMM"
    chats:
      - "@copywriters_ru"
      - "@smm_jobs"
      
  marketing:
    name: "üìà –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥"
    description: "SEO, –∫–æ–Ω—Ç–µ–∫—Å—Ç, —Ç–∞—Ä–≥–µ—Ç"
    chats:
      - "@marketing_jobs"
      - "@seo_freelance"

  # –î–æ–±–∞–≤—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...

settings:
  parse_interval_hours: 2      # –ö–∞–∫ —á–∞—Å—Ç–æ –ø–∞—Ä—Å–∏—Ç—å
  messages_ttl_days: 30        # –°–∫–æ–ª—å–∫–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
  batch_size: 50               # –°–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å Claude
  request_delay_sec: 1.5       # –ü–∞—É–∑–∞ –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏ (–∞–Ω—Ç–∏–±–∞–Ω)
```

---

## –ú–æ–¥–µ–ª–∏ –ë–î (core/models.py)

```python
from sqlalchemy import Column, Integer, String, Text, DateTime, JSON, Boolean, Index
from sqlalchemy.orm import declarative_base
from datetime import datetime

Base = declarative_base()

class FreelanceRequest(Base):
    __tablename__ = "freelance_requests"
    
    id = Column(Integer, primary_key=True)
    
    # –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
    category = Column(String(50), nullable=False, index=True)
    title = Column(String(200), nullable=False)
    description = Column(Text)
    budget = Column(String(100))
    skills = Column(JSON, default=list)  # ["Python", "Django", "PostgreSQL"]
    contact = Column(String(500))
    urgency = Column(String(20), default="normal")  # urgent / normal
    
    # –ò—Å—Ç–æ—á–Ω–∏–∫
    source_chat = Column(String(100))
    source_message_id = Column(Integer)
    message_date = Column(DateTime, nullable=False)
    message_text_hash = Column(String(64), unique=True)  # –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
    
    # –ú–µ—Ç–∞
    parsed_at = Column(DateTime, default=datetime.utcnow)
    is_active = Column(Boolean, default=True)
    
    __table_args__ = (
        Index("idx_category_date", "category", "message_date"),
        Index("idx_active_category", "is_active", "category"),
    )


class ParseLog(Base):
    __tablename__ = "parse_logs"
    
    id = Column(Integer, primary_key=True)
    started_at = Column(DateTime, default=datetime.utcnow)
    finished_at = Column(DateTime)
    status = Column(String(20))  # running / success / failed
    chats_parsed = Column(Integer, default=0)
    messages_found = Column(Integer, default=0)
    requests_extracted = Column(Integer, default=0)
    error_message = Column(Text)


class Category(Base):
    __tablename__ = "categories"
    
    id = Column(Integer, primary_key=True)
    slug = Column(String(50), unique=True, nullable=False)
    name = Column(String(100), nullable=False)
    description = Column(String(500))
    is_active = Column(Boolean, default=True)
    chats_count = Column(Integer, default=0)
    last_parsed_at = Column(DateTime)
```

---

## –ü–∞—Ä—Å–µ—Ä (worker/jobs/parser.py)

```python
import asyncio
import hashlib
from datetime import datetime, timedelta
from telethon import TelegramClient
from core.config import settings
from core.database import async_session
from core.models import FreelanceRequest
import logging

logger = logging.getLogger(__name__)


class ChatParser:
    def __init__(self, client: TelegramClient):
        self.client = client
        
    async def parse_chat(self, chat_id: str | int, days: int = 7) -> list[dict]:
        """–ü–∞—Ä—Å–∏—Ç –æ–¥–∏–Ω —á–∞—Ç –∑–∞ N –¥–Ω–µ–π"""
        messages = []
        since = datetime.now() - timedelta(days=days)
        
        try:
            async for msg in self.client.iter_messages(
                chat_id,
                offset_date=since,
                limit=1000  # –õ–∏–º–∏—Ç –Ω–∞ —á–∞—Ç
            ):
                if not msg.text or len(msg.text) < 50:
                    continue
                    
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –±–æ—Ç–æ–≤ –∏ —Å–µ—Ä–≤–∏—Å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                if msg.sender and getattr(msg.sender, 'bot', False):
                    continue
                
                messages.append({
                    "chat_id": str(chat_id),
                    "message_id": msg.id,
                    "date": msg.date.isoformat(),
                    "text": msg.text[:2000],  # –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ
                    "hash": hashlib.sha256(msg.text.encode()).hexdigest()[:16]
                })
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ {chat_id}: {e}")
            
        return messages
    
    async def parse_category(
        self, 
        category_slug: str, 
        chat_ids: list[str | int],
        days: int = 7
    ) -> list[dict]:
        """–ü–∞—Ä—Å–∏—Ç –≤—Å–µ —á–∞—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å –ø–∞—É–∑–∞–º–∏"""
        all_messages = []
        
        for i, chat_id in enumerate(chat_ids):
            logger.info(f"[{category_slug}] –ü–∞—Ä—Å–∏–Ω–≥ {i+1}/{len(chat_ids)}: {chat_id}")
            
            messages = await self.parse_chat(chat_id, days)
            for msg in messages:
                msg["category"] = category_slug
            all_messages.extend(messages)
            
            # –ê–Ω—Ç–∏–±–∞–Ω –ø–∞—É–∑–∞
            if i < len(chat_ids) - 1:
                await asyncio.sleep(settings.REQUEST_DELAY_SEC)
                
        logger.info(f"[{category_slug}] –°–æ–±—Ä–∞–Ω–æ {len(all_messages)} —Å–æ–æ–±—â–µ–Ω–∏–π")
        return all_messages
```

---

## –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä Gemini (worker/jobs/analyzer.py)

```python
import json
import google.generativeai as genai
from core.config import settings
import logging

logger = logging.getLogger(__name__)

SYSTEM_PROMPT = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É —Ñ—Ä–∏–ª–∞–Ω—Å-—á–∞—Ç–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∏–∑–≤–ª–µ—á—å –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Ä–∞–±–æ—Ç—É (–∑–∞–∫–∞–∑—ã).

–ò–ó–í–õ–ï–ö–ê–ô –∑–∞–ø—Ä–æ—Å—ã –≥–¥–µ —á–µ–ª–æ–≤–µ–∫ –ò–©–ï–¢ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è:
- "–ù—É–∂–µ–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫...", "–ò—â—É –¥–∏–∑–∞–π–Ω–µ—Ä–∞...", "–¢—Ä–µ–±—É–µ—Ç—Å—è..."
- "–°–¥–µ–ª–∞—Ç—å —Å–∞–π—Ç...", "–ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –ª–æ–≥–æ—Ç–∏–ø..."
- "–ë—é–¥–∂–µ—Ç: ...", "–û–ø–ª–∞—Ç–∞: ..."

–ò–ì–ù–û–†–ò–†–£–ô:
- –†–µ–∑—é–º–µ –∏ —Å–∞–º–æ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ ("–Ø —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫, –∏—â—É —Ä–∞–±–æ—Ç—É")
- –í–æ–ø—Ä–æ—Å—ã –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è ("–ö–∞–∫ –ª—É—á—à–µ —Å–¥–µ–ª–∞—Ç—å...?")
- –†–µ–∫–ª–∞–º—É –∫—É—Ä—Å–æ–≤, –∫–∞–Ω–∞–ª–æ–≤, —Å–µ—Ä–≤–∏—Å–æ–≤
- –°–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–¥–∞—á–∏
- –û—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–π —Å–ø–∞–º

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤–µ—Ä–Ω–∏ JSON –æ–±—ä–µ–∫—Ç:
{
  "title": "–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–¥–æ 60 —Å–∏–º–≤–æ–ª–æ–≤)",
  "description": "–°—É—Ç—å –∑–∞–¥–∞—á–∏ –≤ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö",
  "budget": "–ë—é–¥–∂–µ—Ç –∏–ª–∏ '–ù–µ —É–∫–∞–∑–∞–Ω'",
  "skills": ["skill1", "skill2"],
  "contact": "–ö–æ–Ω—Ç–∞–∫—Ç –µ—Å–ª–∏ –µ—Å—Ç—å –∏–ª–∏ null",
  "urgency": "urgent" –∏–ª–∏ "normal",
  "source_message_id": <id —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö>
}

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON –º–∞—Å—Å–∏–≤ –±–µ–∑ markdown-–æ–±—ë—Ä—Ç–∫–∏. –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–µ—Ç ‚Äî –≤–µ—Ä–Ω–∏ []."""


class GeminiAnalyzer:
    def __init__(self):
        genai.configure(api_key=settings.GEMINI_API_KEY)
        self.model = genai.GenerativeModel(
            model_name="gemini-2.0-flash",
            system_instruction=SYSTEM_PROMPT,
            generation_config=genai.GenerationConfig(
                temperature=0.1,
                response_mime_type="application/json"  # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç JSON –æ—Ç–≤–µ—Ç
            )
        )
        
    async def analyze_batch(self, messages: list[dict]) -> list[dict]:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞—Ç—á —Å–æ–æ–±—â–µ–Ω–∏–π"""
        if not messages:
            return []
            
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª—è Gemini
        formatted = "\n\n---\n\n".join([
            f"[ID: {m['message_id']}] [–î–∞—Ç–∞: {m['date']}]\n{m['text']}"
            for m in messages
        ])
        
        try:
            response = await self.model.generate_content_async(
                f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∏–∑–≤–ª–µ–∫–∏ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Ä–∞–±–æ—Ç—É:\n\n{formatted}"
            )
            
            # Gemini —Å response_mime_type="application/json" –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å—Ç—ã–π JSON
            text = response.text
            
            # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —É–±–∏—Ä–∞–µ–º markdown –µ—Å–ª–∏ –µ—Å—Ç—å
            if "```json" in text:
                text = text.split("```json")[1].split("```")[0]
            elif "```" in text:
                text = text.split("```")[1].split("```")[0]
                
            return json.loads(text.strip())
            
        except json.JSONDecodeError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç Gemini: {e}")
            return []
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ Gemini API: {e}")
            return []
    
    async def analyze_all(
        self, 
        messages: list[dict], 
        batch_size: int = 100  # Gemini –∏–º–µ–µ—Ç –±–æ–ª—å—à–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ
    ) -> list[dict]:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–∞—Ç—á–∞–º–∏"""
        all_requests = []
        
        for i in range(0, len(messages), batch_size):
            batch = messages[i:i + batch_size]
            logger.info(f"–ê–Ω–∞–ª–∏–∑ –±–∞—Ç—á–∞ {i//batch_size + 1}/{(len(messages)-1)//batch_size + 1}")
            
            requests = await self.analyze_batch(batch)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            msg_map = {m["message_id"]: m for m in batch}
            for req in requests:
                msg_id = req.get("source_message_id")
                if msg_id and msg_id in msg_map:
                    req["source_chat"] = msg_map[msg_id]["chat_id"]
                    req["message_date"] = msg_map[msg_id]["date"]
                    req["category"] = msg_map[msg_id]["category"]
                    req["message_text_hash"] = msg_map[msg_id]["hash"]
                    
            all_requests.extend(requests)
            
        return all_requests
```

---

## –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (worker/scheduler.py)

```python
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.interval import IntervalTrigger
from worker.jobs.parser import ChatParser
from worker.jobs.analyzer import GeminiAnalyzer
from worker.telethon_client import get_telethon_client
from services.request_service import RequestService
from core.config import settings, load_chats_config
from core.database import async_session
import logging

logger = logging.getLogger(__name__)


async def parse_and_analyze_job():
    """–ì–ª–∞–≤–Ω–∞—è –¥–∂–æ–±–∞: –ø–∞—Ä—Å–∏–Ω–≥ + –∞–Ω–∞–ª–∏–∑ + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ"""
    logger.info("=== –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ ===")
    
    config = load_chats_config()
    client = await get_telethon_client()
    parser = ChatParser(client)
    analyzer = GeminiAnalyzer()
    
    async with async_session() as session:
        request_service = RequestService(session)
        
        # –°–æ–∑–¥–∞—ë–º –ª–æ–≥
        log_id = await request_service.create_parse_log()
        
        total_messages = 0
        total_requests = 0
        
        try:
            for category_slug, category_data in config["categories"].items():
                chat_ids = category_data.get("chats", [])
                if not chat_ids:
                    continue
                    
                logger.info(f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category_slug} ({len(chat_ids)} —á–∞—Ç–æ–≤)")
                
                # –ü–∞—Ä—Å–∏–º
                messages = await parser.parse_category(
                    category_slug, 
                    chat_ids,
                    days=7
                )
                total_messages += len(messages)
                
                if not messages:
                    continue
                
                # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º
                requests = await analyzer.analyze_all(messages)
                total_requests += len(requests)
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º (—Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π)
                await request_service.save_requests(requests)
                
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏
            await request_service.cleanup_old_requests(days=30)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥
            await request_service.finish_parse_log(
                log_id,
                status="success",
                messages_found=total_messages,
                requests_extracted=total_requests
            )
            
            logger.info(f"=== –ì–æ—Ç–æ–≤–æ: {total_messages} —Å–æ–æ–±—â–µ–Ω–∏–π ‚Üí {total_requests} –∑–∞–ø—Ä–æ—Å–æ–≤ ===")
            
        except Exception as e:
            logger.exception("–û—à–∏–±–∫–∞ –≤ –¥–∂–æ–±–µ –ø–∞—Ä—Å–∏–Ω–≥–∞")
            await request_service.finish_parse_log(log_id, status="failed", error=str(e))


def create_scheduler() -> AsyncIOScheduler:
    scheduler = AsyncIOScheduler()
    
    # –ö–∞–∂–¥—ã–µ N —á–∞—Å–æ–≤
    scheduler.add_job(
        parse_and_analyze_job,
        trigger=IntervalTrigger(hours=settings.PARSE_INTERVAL_HOURS),
        id="main_parser",
        name="–ü–∞—Ä—Å–∏–Ω–≥ —Ñ—Ä–∏–ª–∞–Ω—Å-—á–∞—Ç–æ–≤",
        replace_existing=True
    )
    
    # –°—Ä–∞–∑—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    scheduler.add_job(
        parse_and_analyze_job,
        id="initial_parse",
        name="–ü–µ—Ä–≤–∏—á–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥"
    )
    
    return scheduler
```

---

## Telegram –±–æ—Ç ‚Äî —Ö–µ–Ω–¥–ª–µ—Ä—ã (bot/handlers/start.py)

```python
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command
from bot.keyboards import get_categories_keyboard, get_period_keyboard
from services.category_service import CategoryService
from core.database import async_session

router = Router()


@router.message(Command("start"))
async def cmd_start(message: Message):
    await message.answer(
        "üëã <b>–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ—Ä–∏–ª–∞–Ω—Å-–∑–∞–∫–∞–∑–æ–≤.</b>\n\n"
        "–Ø —Å–æ–±–∏—Ä–∞—é –∑–∞–ø—Ä–æ—Å—ã –∏–∑ 100+ —á–∞—Ç–æ–≤ –∏ –ø–æ–∫–∞–∑—ã–≤–∞—é –∏—Ö –≤ —É–¥–æ–±–Ω–æ–º –≤–∏–¥–µ.\n\n"
        "–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        reply_markup=get_categories_keyboard()
    )


@router.callback_query(F.data.startswith("category:"))
async def select_category(callback: CallbackQuery):
    category_slug = callback.data.split(":")[1]
    
    async with async_session() as session:
        service = CategoryService(session)
        category = await service.get_by_slug(category_slug)
        
    await callback.message.edit_text(
        f"üìÅ <b>{category.name}</b>\n\n"
        f"{category.description}\n\n"
        "–ó–∞ –∫–∞–∫–æ–π –ø–µ—Ä–∏–æ–¥ –ø–æ–∫–∞–∑–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã?",
        reply_markup=get_period_keyboard(category_slug)
    )
```

---

## Telegram –±–æ—Ç ‚Äî –ø–æ–∫–∞–∑ –∑–∞–ø—Ä–æ—Å–æ–≤ (bot/handlers/requests.py)

```python
from aiogram import Router, F
from aiogram.types import CallbackQuery
from services.request_service import RequestService
from bot.keyboards import get_pagination_keyboard, get_back_keyboard
from core.database import async_session

router = Router()

REQUESTS_PER_PAGE = 5


@router.callback_query(F.data.startswith("requests:"))
async def show_requests(callback: CallbackQuery):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ø–µ—Ä–∏–æ–¥—É"""
    _, category_slug, days, page = callback.data.split(":")
    days = int(days)
    page = int(page)
    
    async with async_session() as session:
        service = RequestService(session)
        
        requests, total = await service.get_requests(
            category=category_slug,
            days=days,
            offset=page * REQUESTS_PER_PAGE,
            limit=REQUESTS_PER_PAGE
        )
    
    if not requests:
        await callback.message.edit_text(
            f"üòï –ó–∞ {days} –¥–Ω–µ–π –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–µ—Ä–∏–æ–¥ –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é.",
            reply_markup=get_back_keyboard()
        )
        return
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
    text = f"üìã <b>–ù–∞–π–¥–µ–Ω–æ {total} –∑–∞–ø—Ä–æ—Å–æ–≤</b> (—Å—Ç—Ä. {page + 1}/{(total - 1) // REQUESTS_PER_PAGE + 1})\n\n"
    
    for i, req in enumerate(requests, start=page * REQUESTS_PER_PAGE + 1):
        text += f"<b>{i}. {req.title}</b>\n"
        text += f"{req.description}\n"
        text += f"üí∞ {req.budget}"
        
        if req.skills:
            skills_str = ", ".join(req.skills[:3])
            text += f" | üõ† {skills_str}"
            
        if req.contact:
            text += f"\nüì© {req.contact}"
            
        if req.urgency == "urgent":
            text += " üî•"
            
        text += "\n\n"
    
    await callback.message.edit_text(
        text,
        reply_markup=get_pagination_keyboard(category_slug, days, page, total, REQUESTS_PER_PAGE)
    )


@router.callback_query(F.data == "refresh")
async def refresh_requests(callback: CallbackQuery):
    """–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (–ø–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–∞—Ä—Å–∏–Ω–≥ –±—ã–ª –≤ ...)"""
    async with async_session() as session:
        service = RequestService(session)
        last_log = await service.get_last_parse_log()
        
    if last_log:
        await callback.answer(
            f"‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: {last_log.finished_at.strftime('%H:%M')}\n"
            f"–°–ª–µ–¥—É—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ~{2 - (datetime.now() - last_log.finished_at).seconds // 3600} —á.",
            show_alert=True
        )
    else:
        await callback.answer("‚è≥ –ü–∞—Ä—Å–∏–Ω–≥ –µ—â—ë –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è", show_alert=True)
```

---

## –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã (bot/keyboards.py)

```python
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from core.config import load_chats_config


def get_categories_keyboard() -> InlineKeyboardMarkup:
    config = load_chats_config()
    buttons = []
    
    for slug, data in config["categories"].items():
        buttons.append([
            InlineKeyboardButton(
                text=data["name"],
                callback_data=f"category:{slug}"
            )
        ])
    
    # –ö–Ω–æ–ø–∫–∞ "–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"
    buttons.append([
        InlineKeyboardButton(text="üåê –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", callback_data="category:all")
    ])
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def get_period_keyboard(category: str) -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="üìÖ 7 –¥–Ω–µ–π", callback_data=f"requests:{category}:7:0"),
            InlineKeyboardButton(text="üìÖ 30 –¥–Ω–µ–π", callback_data=f"requests:{category}:30:0"),
        ],
        [
            InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back:start")
        ]
    ])


def get_pagination_keyboard(
    category: str, 
    days: int, 
    page: int, 
    total: int,
    per_page: int
) -> InlineKeyboardMarkup:
    buttons = []
    nav_row = []
    
    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
    if page > 0:
        nav_row.append(
            InlineKeyboardButton(text="‚óÄÔ∏è", callback_data=f"requests:{category}:{days}:{page - 1}")
        )
    
    # –°—á—ë—Ç—á–∏–∫ —Å—Ç—Ä–∞–Ω–∏—Ü
    nav_row.append(
        InlineKeyboardButton(text=f"{page + 1}/{(total - 1) // per_page + 1}", callback_data="noop")
    )
    
    # –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä—ë–¥"
    if (page + 1) * per_page < total:
        nav_row.append(
            InlineKeyboardButton(text="‚ñ∂Ô∏è", callback_data=f"requests:{category}:{days}:{page + 1}")
        )
    
    buttons.append(nav_row)
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    buttons.append([
        InlineKeyboardButton(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="refresh"),
        InlineKeyboardButton(text="‚óÄÔ∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–∏", callback_data="back:start")
    ])
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def get_back_keyboard() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back:start")]
    ])
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (core/config.py)

```python
from pydantic_settings import BaseSettings
from functools import lru_cache
import yaml


class Settings(BaseSettings):
    # Telegram Bot
    BOT_TOKEN: str
    ADMIN_IDS: list[int] = []  # Whitelist –∞–¥–º–∏–Ω–æ–≤
    
    # Telethon (userbot)
    TELEGRAM_API_ID: int
    TELEGRAM_API_HASH: str
    TELEGRAM_PHONE: str
    
    # Gemini
    GEMINI_API_KEY: str
    
    # Database
    DATABASE_URL: str = "postgresql+asyncpg://user:pass@localhost:5432/freelance_parser"
    
    # Parser settings
    PARSE_INTERVAL_HOURS: int = 2
    REQUEST_DELAY_SEC: float = 1.5
    MESSAGES_TTL_DAYS: int = 30
    BATCH_SIZE: int = 50
    
    class Config:
        env_file = ".env"


@lru_cache
def get_settings() -> Settings:
    return Settings()


settings = get_settings()


@lru_cache
def load_chats_config() -> dict:
    with open("config/chats.yaml", "r", encoding="utf-8") as f:
        return yaml.safe_load(f)
```

---

## Docker Compose

```yaml
version: "3.8"

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: freelance
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: freelance_parser
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U freelance"]
      interval: 5s
      timeout: 5s
      retries: 5

  bot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    depends_on:
      postgres:
        condition: service_healthy
    env_file: .env
    environment:
      DATABASE_URL: postgresql+asyncpg://freelance:${DB_PASSWORD}@postgres:5432/freelance_parser
    restart: unless-stopped

  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    depends_on:
      postgres:
        condition: service_healthy
    env_file: .env
    environment:
      DATABASE_URL: postgresql+asyncpg://freelance:${DB_PASSWORD}@postgres:5432/freelance_parser
    volumes:
      - ./sessions:/app/sessions  # Telethon —Å–µ—Å—Å–∏–∏
    restart: unless-stopped

volumes:
  postgres_data:
```

---

## .env.example

```bash
# Telegram Bot
BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
ADMIN_IDS=[123456789, 987654321]

# Telethon (–ø–æ–ª—É—á–∏—Ç—å –Ω–∞ my.telegram.org)
TELEGRAM_API_ID=12345678
TELEGRAM_API_HASH=abcdef1234567890abcdef1234567890
TELEGRAM_PHONE=+79001234567

# Gemini API (–ø–æ–ª—É—á–∏—Ç—å –Ω–∞ aistudio.google.com)
GEMINI_API_KEY=AIzaSy...

# Database
DB_PASSWORD=supersecretpassword

# Settings
PARSE_INTERVAL_HOURS=2
REQUEST_DELAY_SEC=1.5
```

---

## –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫

1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å `.env.example` ‚Üí `.env` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å
3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å `config/chats.yaml` —Å–≤–æ–∏–º–∏ —á–∞—Ç–∞–º–∏
4. –ó–∞–ø—É—Å—Ç–∏—Ç—å:

```bash
# –ü–µ—Ä–≤—ã–π —Ä–∞–∑ ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Telethon
docker-compose run --rm worker python -c "from worker.telethon_client import auth; auth()"

# –ó–∞–ø—É—Å–∫ –≤—Å–µ–≥–æ
docker-compose up -d

# –õ–æ–≥–∏
docker-compose logs -f worker
docker-compose logs -f bot
```

---

## –ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```
/status ‚Äî —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
/parse ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –≤—Ä—É—á–Ω—É—é
/stats ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º)
```

---

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **Telethon —Å–µ—Å—Å–∏—è** ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ volume, –Ω–µ –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ
2. **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è** ‚Äî –ø–æ —Ö–µ—à—É —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è, –¥—É–±–ª–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è
3. **–ê–Ω—Ç–∏–±–∞–Ω** ‚Äî –ø–∞—É–∑–∞ 1.5 —Å–µ–∫ –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏, –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –µ—Å–ª–∏ –±–∞–Ω—è—Ç
4. **TTL –∑–∞–ø–∏—Å–µ–π** ‚Äî —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π
5. **Whitelist** ‚Äî –¥–æ–±–∞–≤—å ADMIN_IDS —á—Ç–æ–±—ã –Ω–µ –≤—Å–µ –º–æ–≥–ª–∏ —é–∑–∞—Ç—å –±–æ—Ç–∞

---

–ì–æ—Ç–æ–≤–æ! –ù–∞—á–Ω–∏ —Å `docker-compose up` –∏ —Å–º–æ—Ç—Ä–∏ –ª–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–∞.
